(()=>{"use strict";function e(e){e.querySelector("input").value=""}function t(e){e.focus(),e.selectionStart=e.value.length}class n{constructor(e,t,n){this.type=e,this.name=t,this.body=n}}function s(e,t,n,s,a){let o="",l="",c=t;t===localStorage.getItem("userName")&&(c="You",o=" you_upper_block",l=" you_message__text"),e.insertAdjacentHTML("beforeend",`\n    <div class="message" id="${a}">\n      <div class="upper_block${o}">\n        <div class="_message__user">${c},</div>\n        <div class="message__date">${s}</div>\n      </div>\n      <div class="message__text${l}">${n}</div>\n    </div>`),e.parentElement.scrollTop=e.parentElement.scrollHeight}function a(e,t){let n="",s=t;t===localStorage.getItem("userName")&&(s="You",n=" you_user-widget__name"),e.insertAdjacentHTML("beforeend",`\n    <div class="user-widget">\n      <div class="user-widget__avatar"></div>\n      <div class="user-widget__name${n}">${s}</div>\n    </div>`),e.scrollTop=e.scrollHeight}function o(e,t,s,a){const o=new n(t,s,a),l=JSON.stringify(o);e.send(l)}const l="ws://localhost:7070/ws";document.addEventListener("DOMContentLoaded",(()=>{const n=document.getElementById("continue"),c=document.getElementById("Add_UserName_Form"),d=document.getElementById("AddForm"),r=document.getElementById("chat-widget__input"),i=document.querySelector(".warning__banner"),u=document.getElementById("chat-widget__messages"),m=document.getElementById("user-widget_area");c.addEventListener("submit",(e=>{e.preventDefault()}));let g=!1,v="",_="",y={},p=[],w=[],S=new WebSocket(l);S.binaryType="blob",S.addEventListener("open",(()=>{S.readyState===WebSocket.OPEN&&(console.log("ws-connect successfull!"),g=!0,o(S,"helloServer",v,"hello, Server!"))})),S.addEventListener("message",(n=>{console.log("new response resived!");const l=JSON.parse(n.data),{type:g}=l,_=l.name,{body:f}=l,h=l.created,E=l.id;switch(g){case"helloClient":return console.log(h,"  ",f),void console.log("----------------------");case"invalidName":return e(d),v="",void i.classList.remove("display_none");case"nameAdded":return e(d),v=_,localStorage.setItem("userName",v),i.classList.add("display_none"),c.classList.add("display_none"),console.log(`User ${_} was joined to the Chat.`),o(S,"allMessages",_),void o(S,"allUsers",_);case"allMessages":p=JSON.parse(f);for(let e=0;e<p.length;e++){const{name:t}=p[e],{message:n}=p[e],{created:a}=p[e];s(u,t,n,a)}return;case"allUsers":w=JSON.parse(f);for(let e=0;e<w.length;e++){const{name:n}=w[e],{message:s}=w[e],{created:o}=w[e],{id:l}=w[e];a(m,n),t(r)}return;case"new message added!":y=JSON.parse(f);const{name:n}=y,{message:l}=y,{created:g}=y;return void s(u,n,l,g);case"SomeOne user abandoned us!":return b=E,document.getElementById(`${b}`).remove(),void t(r);default:console.log("fuckOff!")}var b})),S.addEventListener("close",(e=>{e.wasClean?(alert(`[close] Соединение закрыто чисто, код=${e.code} причина=${e.reason}`),g=!1):(alert("[close] Соединение прервано"),g=!1,console.log("WebSocket connection was failed! Trying reconnect..."),setTimeout((()=>{S=new WebSocket(l),console.log("Trying ws-reconnect now...")}),3e3))})),d.querySelector("input").onchange=()=>{v=d.querySelector("input").value,d.querySelector("input").value=""},r.onchange=()=>{_=r.value,r.value="",o(S,"addMessage",v,_)},c.addEventListener("click",(()=>{n.addEventListener("click",(function e(){g?""!==v?(o(S,"addName",v),n.removeEventListener("click",e)):alert("Заполни поле!"):alert("Связь с сервером не установлена! Перезагрузи страницу.")}))}))}))})();